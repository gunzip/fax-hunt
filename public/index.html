<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Gioco di Tiro al Bersaglio</title>
    <!-- Socket.IO Client -->
    <script
      src="https://cdn.socket.io/4.5.4/socket.io.min.js"
      crossorigin="anonymous"
    ></script>

    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap"
      rel="stylesheet"
    />

    <style>
      body {
        font-family: "Roboto", Arial, sans-serif;
        text-align: center;
        font-family: Arial, sans-serif;
        background-color: #fafafa;
        margin: 0;
        padding: 20px;

        background-image: url("/background.png");
        background-size: cover;
        background-position: center;
      }

      canvas {
        cursor: crosshair;
        width: 100%;
        height: auto;
        max-width: 1024px;
        max-height: 600px;
        border: 1px solid #ece2e2;
      }

      .info {
        background: linear-gradient(
          90deg,
          #4caf50,
          #2c3e50
        ); /* Green to dark blue gradient */
        padding: 20px 25px; /* Increased padding for more space */
        border-radius: 15px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); /* Slightly darker and bigger shadow */
        color: #f7f7f7; /* Light gray for better readability */
        font-family: "Poppins", sans-serif;
        font-size: 18px; /* Slightly larger text */
        text-align: center;
        margin: 20px auto; /* More margin for better spacing */
        max-width: 600px;
        line-height: 1.6; /* Improved readability */
      }

      /* Styling the link */
      .info a {
        color: #ffd700; /* Gold color for the link */
        text-decoration: none;
        font-weight: bold;
        transition: color 0.3s ease, text-decoration 0.3s ease;
      }

      .info a:hover {
        color: #ffffff; /* White on hover for better contrast */
        text-decoration: underline;
      }

      /* Container for the bottom paragraph */
      #userList {
        background-color: #2c3e50; /* Darker blue for better contrast */
        padding: 14px 20px; /* More padding for better readability */
        border-radius: 25px; /* Smooth, pill-like shape */
        color: #f7f7f7; /* Light gray for better readability */
        font-family: "Poppins", sans-serif;
        font-size: 16px; /* Slightly larger text */
        text-align: center;
        max-width: 250px; /* Slightly wider for better fit */
        margin: 30px auto; /* More space between elements */
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); /* Subtle shadow for depth */
        position: relative;
      }

      /* Adding a pulse effect to indicate activity */
      #userList::after {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        width: 100%;
        height: 100%;
        border-radius: 50%;
        background: rgba(
          44,
          62,
          80,
          0.2
        ); /* Dark blue with lower transparency for subtle pulse */
        transform: translate(-50%, -50%);
        animation: pulse 2s infinite;
        z-index: -1;
      }

      @keyframes pulse {
        0% {
          transform: translate(-50%, -50%) scale(1);
          opacity: 1;
        }
        100% {
          transform: translate(-50%, -50%) scale(1.5);
          opacity: 0;
        }
      }

      button {
        font-size: 16px;
        padding: 10px 20px;
        background-color: #4caf50;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        margin-top: 20px;
      }
      button:hover {
        background-color: #45a049;
      }
      h1 {
        color: #4caf50;
        margin-top: 20px;
      }
    </style>
  </head>
  <body>
    <!-- Audio Elements -->
    <audio id="laserSound" src="/laser-shot.mp3" preload="auto"></audio>
    <audio id="winning" src="/winning.mp3" preload="auto"></audio>
    <audio id="explosion" src="/explosion.mp3" preload="auto"></audio>

    <!-- Information Section -->
    <div class="info">
      Join the game via API (
      <a href="/openapi.yaml" target="_blank" rel="noopener noreferrer">
        OpenAPI specs here
      </a>
      ), get a token, and shoot at a moving target by sending API requests with
      X, Y coordinates. Hit the target first to win.
    </div>

    <!-- Canvas Element -->
    <canvas id="gameCanvas" width="1024" height="600"></canvas>

    <div class="info" id="userList">
      <p id="users">Waiting to get connected users...</p>
      <p id="winnerMessage"></p>
    </div>

    <script>
      (function () {
        // Initialize Variables
        const canvas = document.getElementById("gameCanvas");
        const context = canvas.getContext("2d");
        const laserSound = document.getElementById("laserSound");
        const winningSound = document.getElementById("winning");
        const explosionSound = document.getElementById("explosion");
        const winnerMessage = document.getElementById("winnerMessage");
        const usersMessage = document.getElementById("users");

        let socket = null;
        let objectPosition = { x: 400, y: 300 };
        let targetPosition = { x: 400, y: 300 };
        let shots = [];
        let gameActive = true;
        let winner = null;
        let spriteImage = null;
        let lastUpdateTime = Date.now();
        let gameStartTime = Date.now();

        // Disable console and fetch
        console.log = function () {};
        window.fetch = function () {};

        // Initialize Socket.IO
        function socketInitializer() {
          // const socketUrl = "http://localhost:3000"; // Update if necessary
          socket = io();

          socket.on("connect", () => {
            console.log("Connected to server");
          });

          socket.on("connect_error", (error) => {
            console.error("Error connecting to socket: " + error.message);
          });

          socket.on("error", (errorMessage) => {
            console.error("Error: " + errorMessage);
          });

          socket.on("updateUserList", (players) => {
            usersMessage.innerHTML =
              players.length +
              " connected user" +
              (players.length === 1 ? "" : "s");
          });

          socket.on("newShot", (shot) => {
            shots.push(shot);
            playLaserSound();
            setTimeout(() => {
              shots = shots.filter((s) => s !== shot);
            }, 1000);
            draw(); // Trigger redraw
          });

          socket.on("objectPosition", (position) => {
            targetPosition = position;
            lastUpdateTime = Date.now();
            draw(); // Trigger redraw
          });

          socket.on("gameOver", ({ winner }) => {
            playExplosionSound();
            playWinningSound();
            gameActive = false;
            displayWinner(winner);
          });

          socket.on("gameReset", () => {
            // reload page
            window.location.reload();
          });
        }

        // Preload Images
        function preloadImages() {
          spriteImage = new Image();
          spriteImage.src = "/fax2.webp";
          spriteImage.onload = () => {
            draw(); // Initial draw after images are loaded
          };
        }

        // Draw Function
        function draw() {
          const now = Date.now();
          const deltaTime = now - lastUpdateTime;
          lastUpdateTime = now;

          const lerpFactor = Math.min(deltaTime / 100, 1);

          // Interpolazione della posizione dell'oggetto
          objectPosition.x +=
            (targetPosition.x - objectPosition.x) * lerpFactor;
          objectPosition.y +=
            (targetPosition.y - objectPosition.y) * lerpFactor;

          // Clear canvas
          context.clearRect(0, 0, canvas.width, canvas.height);

          // Draw sprite if game is active
          if (gameActive && spriteImage) {
            const spriteWidth = 64;
            const spriteHeight = 64;
            context.drawImage(
              spriteImage,
              objectPosition.x - spriteWidth / 2,
              objectPosition.y - spriteHeight / 2,
              spriteWidth,
              spriteHeight
            );
          }

          // Draw shots
          shots.forEach((shot) => {
            context.beginPath();
            context.arc(shot.x, shot.y, 5, 0, 2 * Math.PI);
            context.fillStyle = shot.color;
            context.fill();
            context.font = "12px Arial";
            context.fillStyle = "black";
            context.fillText(shot.username, shot.x + 8, shot.y - 8);
          });

          requestAnimationFrame(draw);
        }

        // Play Laser Sound
        function playLaserSound() {
          if (laserSound.readyState >= 2) {
            // HAVE_CURRENT_DATA
            laserSound.currentTime = 0;
            laserSound.play().catch((error) => {
              console.error("Error playing laser sound:", error);
            });
          }
        }

        function playWinningSound() {
          if (winningSound.readyState >= 2) {
            winningSound.currentTime = 0;
            winningSound.play().catch((error) => {
              console.error("Error playing winning sound:", error);
            });
          }
        }

        function playExplosionSound() {
          if (explosionSound.readyState >= 2) {
            explosionSound.currentTime = 0;
            explosionSound.play().catch((error) => {
              console.error("Error playing explosion sound:", error);
            });
          }
        }

        // Display Winner
        function displayWinner(winner) {
          const elapsedTime = getElapsedTime();
          winnerMessage.innerHTML += `<span>${winner} won the game in ${elapsedTime}!</span>`;
        }

        // Prevent Canvas Default Events
        function preventCanvasEvents() {
          const handleEvent = (event) => {
            event.preventDefault();
            event.stopPropagation();
          };
          canvas.addEventListener("click", handleEvent);
          canvas.addEventListener("mouseover", handleEvent);
        }

        function getElapsedTime() {
          // Step 2: Calculate elapsed time
          let elapsedTime = Date.now() - gameStartTime;

          // Step 3: Format elapsed time
          let seconds = Math.floor(elapsedTime / 1000);
          let minutes = Math.floor(seconds / 60);
          seconds = seconds % 60;

          // Step 4: Return elapsed time
          return `${minutes}m ${seconds}s`;
        }

        // Initialize Everything
        function init() {
          gameStartTime = Date.now();
          socketInitializer();
          preloadImages();
          preventCanvasEvents();
          // Handle Window Resize if necessary
          window.addEventListener("resize", draw);
        }

        // Start Initialization after DOM Content is Loaded
        document.addEventListener("DOMContentLoaded", init);
      })();
    </script>
  </body>
</html>
